!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.botService=t():e.botService=t()}(window,(function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=9)}([function(e,t,n){e.exports=n(14)},function(e,t){e.exports=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e},e.exports.default=e.exports,e.exports.__esModule=!0},function(e,t){function n(e,t,n,r,o,i,s){try{var a=e[i](s),c=a.value}catch(e){return void n(e)}a.done?t(c):Promise.resolve(c).then(r,o)}e.exports=function(e){return function(){var t=this,r=arguments;return new Promise((function(o,i){var s=e.apply(t,r);function a(e){n(s,o,i,a,c,"next",e)}function c(e){n(s,o,i,a,c,"throw",e)}a(void 0)}))}},e.exports.default=e.exports,e.exports.__esModule=!0},function(e,t){e.exports=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},e.exports.default=e.exports,e.exports.__esModule=!0},function(e,t){e.exports=function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)},e.exports.default=e.exports,e.exports.__esModule=!0},function(e,t,n){var r=n(6);e.exports=function(e,t){if(e){if("string"==typeof e)return r(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?r(e,t):void 0}},e.exports.default=e.exports,e.exports.__esModule=!0},function(e,t){e.exports=function(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r},e.exports.default=e.exports,e.exports.__esModule=!0},function(e,t,n){var r=n(10),o=n(4),i=n(5),s=n(11);e.exports=function(e){return r(e)||o(e)||i(e)||s()},e.exports.default=e.exports,e.exports.__esModule=!0},function(e,t,n){var r=n(12),o=n(4),i=n(5),s=n(13);e.exports=function(e){return r(e)||o(e)||i(e)||s()},e.exports.default=e.exports,e.exports.__esModule=!0},function(e,t,n){e.exports=n(15)},function(e,t){e.exports=function(e){if(Array.isArray(e))return e},e.exports.default=e.exports,e.exports.__esModule=!0},function(e,t){e.exports=function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")},e.exports.default=e.exports,e.exports.__esModule=!0},function(e,t,n){var r=n(6);e.exports=function(e){if(Array.isArray(e))return r(e)},e.exports.default=e.exports,e.exports.__esModule=!0},function(e,t){e.exports=function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")},e.exports.default=e.exports,e.exports.__esModule=!0},function(e,t,n){var r=function(e){"use strict";var t=Object.prototype,n=t.hasOwnProperty,r="function"==typeof Symbol?Symbol:{},o=r.iterator||"@@iterator",i=r.asyncIterator||"@@asyncIterator",s=r.toStringTag||"@@toStringTag";function a(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{a({},"")}catch(e){a=function(e,t,n){return e[t]=n}}function c(e,t,n,r){var o=t&&t.prototype instanceof l?t:l,i=Object.create(o.prototype),s=new k(r||[]);return i._invoke=function(e,t,n){var r="suspendedStart";return function(o,i){if("executing"===r)throw new Error("Generator is already running");if("completed"===r){if("throw"===o)throw i;return A()}for(n.method=o,n.arg=i;;){var s=n.delegate;if(s){var a=b(s,n);if(a){if(a===d)continue;return a}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if("suspendedStart"===r)throw r="completed",n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);r="executing";var c=u(e,t,n);if("normal"===c.type){if(r=n.done?"completed":"suspendedYield",c.arg===d)continue;return{value:c.arg,done:n.done}}"throw"===c.type&&(r="completed",n.method="throw",n.arg=c.arg)}}}(e,n,s),i}function u(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var d={};function l(){}function p(){}function f(){}var h={};h[o]=function(){return this};var v=Object.getPrototypeOf,g=v&&v(v(I([])));g&&g!==t&&n.call(g,o)&&(h=g);var m=f.prototype=l.prototype=Object.create(h);function w(e){["next","throw","return"].forEach((function(t){a(e,t,(function(e){return this._invoke(t,e)}))}))}function y(e,t){var r;this._invoke=function(o,i){function s(){return new t((function(r,s){!function r(o,i,s,a){var c=u(e[o],e,i);if("throw"!==c.type){var d=c.arg,l=d.value;return l&&"object"==typeof l&&n.call(l,"__await")?t.resolve(l.__await).then((function(e){r("next",e,s,a)}),(function(e){r("throw",e,s,a)})):t.resolve(l).then((function(e){d.value=e,s(d)}),(function(e){return r("throw",e,s,a)}))}a(c.arg)}(o,i,r,s)}))}return r=r?r.then(s,s):s()}}function b(e,t){var n=e.iterator[t.method];if(void 0===n){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,b(e,t),"throw"===t.method))return d;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return d}var r=u(n,e.iterator,t.arg);if("throw"===r.type)return t.method="throw",t.arg=r.arg,t.delegate=null,d;var o=r.arg;return o?o.done?(t[e.resultName]=o.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,d):o:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,d)}function x(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function S(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function k(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(x,this),this.reset(!0)}function I(e){if(e){var t=e[o];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var r=-1,i=function t(){for(;++r<e.length;)if(n.call(e,r))return t.value=e[r],t.done=!1,t;return t.value=void 0,t.done=!0,t};return i.next=i}}return{next:A}}function A(){return{value:void 0,done:!0}}return p.prototype=m.constructor=f,f.constructor=p,p.displayName=a(f,s,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,f):(e.__proto__=f,a(e,s,"GeneratorFunction")),e.prototype=Object.create(m),e},e.awrap=function(e){return{__await:e}},w(y.prototype),y.prototype[i]=function(){return this},e.AsyncIterator=y,e.async=function(t,n,r,o,i){void 0===i&&(i=Promise);var s=new y(c(t,n,r,o),i);return e.isGeneratorFunction(n)?s:s.next().then((function(e){return e.done?e.value:s.next()}))},w(m),a(m,s,"Generator"),m[o]=function(){return this},m.toString=function(){return"[object Generator]"},e.keys=function(e){var t=[];for(var n in e)t.push(n);return t.reverse(),function n(){for(;t.length;){var r=t.pop();if(r in e)return n.value=r,n.done=!1,n}return n.done=!0,n}},e.values=I,k.prototype={constructor:k,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(S),!e)for(var t in this)"t"===t.charAt(0)&&n.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function r(n,r){return s.type="throw",s.arg=e,t.next=n,r&&(t.method="next",t.arg=void 0),!!r}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],s=i.completion;if("root"===i.tryLoc)return r("end");if(i.tryLoc<=this.prev){var a=n.call(i,"catchLoc"),c=n.call(i,"finallyLoc");if(a&&c){if(this.prev<i.catchLoc)return r(i.catchLoc,!0);if(this.prev<i.finallyLoc)return r(i.finallyLoc)}else if(a){if(this.prev<i.catchLoc)return r(i.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return r(i.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var s=i?i.completion:{};return s.type=e,s.arg=t,i?(this.method="next",this.next=i.finallyLoc,d):this.complete(s)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),d},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),S(n),d}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var o=r.arg;S(n)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,n){return this.delegate={iterator:I(e),resultName:t,nextLoc:n},"next"===this.method&&(this.arg=void 0),d}},e}(e.exports);try{regeneratorRuntime=r}catch(e){Function("r","regeneratorRuntime = r")(r)}},function(e,t,n){"use strict";n.r(t);var r=n(7),o=n.n(r),i=n(8),s=n.n(i),a=n(3),c=n.n(a),u=n(2),d=n.n(u),l=n(1),p=n.n(l),f=n(0),h=n.n(f),v=function e(t,n){var r=this;c()(this,e),p()(this,"open",d()(h.a.mark((function e(){return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",r.features.getSpeechRecognition().then((function(e){var t=new e;return t.lang=r.language,t.interimResults=!1,t.maxAlternatives=1,t.onresult=function(e){for(var t=0;t<e.results.length;t++)for(var n=e.results[t],o=n.isFinal,i=0;i<n.length&&i<1;i++){var s=n[i];r.cbx({type:"Transcript",transcript:s.transcript,confidence:s.confidence,isFinal:o})}},t.onerror=function(e){console.log("WebSpeech error: ".concat(e.error))},t.onnomatch=function(e){console.log("No match received")},r.recognition=t,Promise.resolve()})));case 1:case"end":return e.stop()}}),e)})))),p()(this,"start",d()(h.a.mark((function e(){return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r.recognition.start(),r.cbx({type:"Event",eventType:"InputAudioStreamOpen"}),e.abrupt("return",Promise.resolve());case 3:case"end":return e.stop()}}),e)})))),p()(this,"stop",d()(h.a.mark((function e(){return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r.recognition.stop(),e.abrupt("return",Promise.resolve());case 2:case"end":return e.stop()}}),e)})))),p()(this,"close",d()(h.a.mark((function e(){return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r.recognition=null,e.abrupt("return",Promise.resolve());case 2:case"end":return e.stop()}}),e)})))),this.features=t,this.cbx=n,console.log("Google STT is being used")},g=function e(t,n,r,o){var i=this;c()(this,e),p()(this,"close",d()(h.a.mark((function e(){return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!i.audioContext){e.next=4;break}return e.next=3,i.audioContext.close();case 3:i.audioContext=null;case 4:return e.abrupt("return",Promise.resolve());case 5:case"end":return e.stop()}}),e)})))),p()(this,"streamAudioData",(function(e){var t=e.inputBuffer.getChannelData(0),n=Int16Array.from(t.map((function(e){var t=e<0?32768*e:32767*e;return Math.max(-32768,Math.min(32768,t))})));i.webSocket.send(n)})),p()(this,"event",(function(e){if("InputAudioStreamOpen"===e.type){var t=i.audioContext,n=i.stream;i.scriptProcessor=null;var r=t.createGain();if(null===n)return;var o=t.createMediaStreamSource(n),s=t.createAnalyser();i.scriptProcessor=r.context.createScriptProcessor(2048,2,2),o.connect(r),r.connect(s),r.connect(i.scriptProcessor),i.scriptProcessor.connect(r.context.destination),i.scriptProcessor.addEventListener("audioprocess",i.streamAudioData)}})),p()(this,"start",d()(h.a.mark((function e(){return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!i.audioContext){e.next=8;break}if("suspended"!==i.audioContext.state){e.next=5;break}return e.abrupt("return",i.audioContext.resume().then((function(){return i.init()})));case 5:if("running"!==i.audioContext.state){e.next=7;break}return e.abrupt("return",i.init());case 7:return e.abrupt("return",Promise.reject("Unhandled AudioContext state [".concat(i.audioContext.state,"]")));case 8:return e.abrupt("return",i.features.getAudioContext().then((function(e){return i.audioContext=new e,i.sampleRate=i.audioContext.sampleRate,i.init()})));case 9:case"end":return e.stop()}}),e)})))),p()(this,"init",d()(h.a.mark((function e(){return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",i.features.getUserMedia().then((function(){return navigator.mediaDevices.getUserMedia({audio:!0})})).then((function(e){return i.stream=e,i.sendAudioOpen(),Promise.resolve()})));case 1:case"end":return e.stop()}}),e)})))),p()(this,"stop",function(){var e=d()(h.a.mark((function e(t){return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t&&i.sendAudioClose(),i.scriptProcessor&&(i.scriptProcessor.removeEventListener("audioprocess",i.streamAudioData),i.scriptProcessor=null),i.stream&&(i.stream.getTracks().forEach((function(e){e.stop()})),i.stream=null),e.abrupt("return",i.audioContext.suspend());case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),this.webSocket=n,this.features=t,this.sendAudioOpen=r,this.sendAudioClose=o},m=function e(t,n,r,o,i){var s=this;c()(this,e),p()(this,"detectEngine",d()(h.a.mark((function e(){return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",s.features.detect("SpeechRecognition").then((function(e){return console.log(e),e?(console.log("chrome"),Promise.resolve("web-speech-api")):Promise.resolve("audio-stream-api")})).catch((function(){return Promise.resolve("audio-stream-api")})));case 1:case"end":return e.stop()}}),e)})))),p()(this,"getEngine",(function(){return s.api})),p()(this,"selectEngine",(function(e){s.api!==e&&("audio-stream-api"===e?s.stt=new g(s.features,s.webSocket,s.sendAudioOpen,s.sendAudioClose):"web-speech-api"===e&&(s.stt=new v(s.features,s.callback)))})),p()(this,"selectLanguage",(function(e){s.stt.language=e})),p()(this,"open",d()(h.a.mark((function e(){return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!s.stt.open){e.next=2;break}return e.abrupt("return",s.stt.open());case 2:return e.abrupt("return",Promise.resolve());case 3:case"end":return e.stop()}}),e)})))),p()(this,"start",d()(h.a.mark((function e(){return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!s.stt.start){e.next=2;break}return e.abrupt("return",s.stt.start());case 2:return e.abrupt("return",Promise.resolve());case 3:case"end":return e.stop()}}),e)})))),p()(this,"stop",function(){var e=d()(h.a.mark((function e(t){return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!s.stt.stop){e.next=2;break}return e.abrupt("return",s.stt.stop(t));case 2:return e.abrupt("return",Promise.resolve());case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),p()(this,"close",d()(h.a.mark((function e(){return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!s.stt.close){e.next=2;break}return e.abrupt("return",s.stt.close());case 2:return e.abrupt("return",Promise.resolve());case 3:case"end":return e.stop()}}),e)})))),p()(this,"event",function(){var e=d()(h.a.mark((function e(t){return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!s.stt.event){e.next=2;break}return e.abrupt("return",s.stt.event(t));case 2:return e.abrupt("return",Promise.resolve());case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),this.features=t,this.webSocket=n,this.callback=r,this.sendAudioOpen=o,this.sendAudioClose=i},w=Intl.DateTimeFormat,y=function e(t,n,r,o,i){var s=this,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"cs-CZ",u=arguments.length>6?arguments[6]:void 0,l=arguments.length>7?arguments[7]:void 0,f=arguments.length>8?arguments[8]:void 0,v=arguments.length>9?arguments[9]:void 0;c()(this,e),p()(this,"onSttCallback",(function(e){var t=e.type,n=e.transcript,r=e.isFinal,o=e.eventType;"Transcript"===t?r&&(s.sendText(n),s.callback({type:"Recognized",message:{items:[{text:n}]}})):"Event"===t&&s.callback({type:o})})),p()(this,"open",d()(h.a.mark((function e(){var t,n;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s.webSocket=new WebSocket(s.wsUrl),s.stt=new m(s.features,s.webSocket,s.onSttCallback,s.sendAudioOpen,s.sendAudioClose),t=s.bot.botCallback.getVoice(),n=void 0===t?s.language:s.voices[t],s.stt.detectEngine().then((function(e){return console.log("detected engine",e),s.stt.selectEngine(e)})).then((function(){s.stt.selectLanguage(n),s.stt.open()})),s.webSocket.onmessage=function(e){if(e.data instanceof ArrayBuffer)s.replay(e.data);else if(e.data instanceof Blob)new Response(e.data).arrayBuffer().then(s.replay);else if("string"==typeof e.data){var t=JSON.parse(e.data);s.stt.event(t),s.callback(t)}},s.webSocket.onerror=function(e){s.errorCallback({type:"Client",message:"Socket error:  ".concat(e)})},s.webSocket.onclose=function(e){console.log("Reason for websocket closing: ",e.reason)},e.abrupt("return",new Promise((function(e){s.webSocket.onopen=function(){s.sendPing(s),s.webSocket.send(JSON.stringify({type:"Init",key:s.key,appKey:s.key,deviceId:s.deviceId,sender:s.deviceId,token:s.token,config:{tts:"RequiredLinks",sttSampleRate:44100,ttsFileType:s.ttsFileType,locale:n,zoneId:w().resolvedOptions().timeZone,voice:t,sendResponseItems:!0,sttInterimResults:!0}})),e()}})));case 9:case"end":return e.stop()}}),e)})))),p()(this,"sendPing",(function(e){window.setTimeout((function(){e.webSocket&&null!==e.sessionId&&(e.webSocket.send(new Int16Array),e.sendPing(e))}),1e4)})),p()(this,"getStt",(function(){return s.stt})),p()(this,"close",d()(h.a.mark((function e(){return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,s.stt.close();case 2:return s.webSocket&&(s.webSocket.close(),s.webSocket=null),e.abrupt("return",Promise.resolve());case 4:case"end":return e.stop()}}),e)})))),p()(this,"sendText",function(){var e=d()(h.a.mark((function e(t){var n;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n={zoneId:w().resolvedOptions().timeZone,locale:s.language,attributes:s.bot.botCallback.getAttributes(),transcript:{text:t}},!s.webSocket){e.next=8;break}if(1!==s.webSocket.readyState){e.next=7;break}return s.webSocket.send(JSON.stringify({type:"Input",input:n})),e.abrupt("return",Promise.resolve());case 7:return e.abrupt("return",Promise.reject("Incorrect websocket state"));case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),p()(this,"sendLogs",(function(e){s.webSocket&&s.webSocket.send(JSON.stringify({type:"Log",entries:e}))})),p()(this,"sendAudioOpen",(function(){s.webSocket&&s.sessionId&&s.webSocket.send(JSON.stringify({type:"InputAudioStreamOpen",message:{appKey:s.key,deviceId:s.deviceId,sender:s.deviceId,token:s.token,sessionId:s.sessionId},appKey:s.key}))})),p()(this,"sendAudioClose",(function(){s.webSocket&&s.webSocket.send(JSON.stringify({type:"InputAudioStreamClose",appKey:s.key}))})),p()(this,"replay",function(){var e=d()(h.a.mark((function e(t){return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",s.features.getAudioContext().then((function(e){var n=new e;return n.decodeAudioData(t).then((function(e){var t=n.createBufferSource();t.buffer=e,t.connect(n.destination),t.onended=function(){n.close()},t.start(0)}))})));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),p()(this,"setSessionId",(function(e){s.sessionId=e})),this.features=t,this.wsUrl=n,this.key=i,this.callback=r,this.errorCallback=o,this.language=a,this.muted=!1,this.deviceId=u,this.bot=l,this.token=f,this.ttsFileType=v,this.voices={George:"en",Grace:"en",Gordon:"en",Gwyneth:"en",Gabriela:"cs",Anthony:"en",Audrey:"en",Arthur:"en",Amy:"en",Michael:"en",Mary:"en",Milan:"cs",Victor:"en",Victoria:"en"}},b=function e(){var t=this;c()(this,e),p()(this,"getUserMedia",d()(h.a.mark((function e(){var n;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.state.getUserMedia){e.next=2;break}return e.abrupt("return",Promise.resolve(t.state.getUserMedia));case 2:if(void 0===navigator.mediaDevices&&(navigator.mediaDevices={}),void 0!==navigator.mediaDevices.getUserMedia){e.next=8;break}if(n=navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||!1){e.next=7;break}return e.abrupt("return",Promise.reject(new Error("getUserMedia is not implemented in this browser")));case 7:navigator.mediaDevices.getUserMedia=function(e){return new Promise((function(t,r){n.call(navigator,e,t,r)}))};case 8:return t.state.getUserMedia=navigator.mediaDevices.getUserMedia,e.abrupt("return",Promise.resolve(t.state.getUserMedia));case 10:case"end":return e.stop()}}),e)})))),p()(this,"getAudioContext",d()(h.a.mark((function e(){return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.state.AudioContext){e.next=2;break}return e.abrupt("return",Promise.resolve(t.state.AudioContext));case 2:if(t.state.AudioContext=window.AudioContext||window.webkitAudioContext||!1,!t.state.AudioContext){e.next=5;break}return e.abrupt("return",Promise.resolve(t.state.AudioContext));case 5:return e.abrupt("return",Promise.reject("AudioContext is not implemented in this browser"));case 6:case"end":return e.stop()}}),e)})))),p()(this,"getSpeechRecognitionOld",d()(h.a.mark((function e(){return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:Promise.resolve(!1);case 1:case"end":return e.stop()}}),e)})))),p()(this,"getSpeechRecognition",d()(h.a.mark((function e(){var n,r,o,i,s,a;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=!!document.documentMode,r=!n&&!!window.StyleMedia,o=!(!window.chrome||!window.chrome.webstore&&!window.chrome.runtime),!(o&&-1!==navigator.userAgent.indexOf("Edg"))&&!r){e.next=6;break}return e.abrupt("return",Promise.reject("Web Speech API.SpeechRecognition does not work in Edge"));case 6:if(i=navigator.userAgent,s=/IEMobile|Windows Phone|Lumia/i.test(i)?"w":/iPhone|iP[oa]d/.test(i)?"i":/Android/.test(i)?"a":/BlackBerry|PlayBook|BB10/.test(i)?"b":/Mobile Safari/.test(i)?"s":/webOS|Mobile|Tablet|Opera Mini|\bCrMo\/|Opera Mobi/i.test(i)?1:0,a=/Android/.test(i)?1:0,t.state.isAndroid=a,t.state.SpeechRecognition=window.SpeechRecognition||window.speechRecognition||window.webkitSpeechRecognition||!1,!t.state.SpeechRecognition){e.next=13;break}return e.abrupt("return",s?Promise.resolve(!1):Promise.resolve(t.state.SpeechRecognition));case 13:return e.abrupt("return",Promise.reject("Web Speech API.SpeechRecognition is not implemented in this browser"));case 14:case"end":return e.stop()}}),e)})))),p()(this,"getSpeechSynthesis",d()(h.a.mark((function e(){return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.state.SpeechSynthesis){e.next=2;break}return e.abrupt("return",Promise.resolve(t.state.SpeechSynthesis));case 2:if(t.state.SpeechSynthesis=window.speechSynthesis||window.webkitSpeechSynthesis||!1,!t.state.SpeechSynthesis){e.next=5;break}return e.abrupt("return",Promise.resolve(t.state.SpeechSynthesis));case 5:return e.abrupt("return",Promise.reject("Web Speech API.SpeechSynthesis is not implemented in this browser"));case 6:case"end":return e.stop()}}),e)})))),p()(this,"detect",function(){var e=d()(h.a.mark((function e(n){return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.t0=n,e.next="getUserMedia"===e.t0?3:"AudioContext"===e.t0?4:"SpeechRecognition"===e.t0?5:"SpeechSynthesis"===e.t0?6:7;break;case 3:return e.abrupt("return",Promise.resolve(t.getUserMedia()));case 4:return e.abrupt("return",Promise.resolve(t.getAudioContext()));case 5:return e.abrupt("return",Promise.resolve(t.getSpeechRecognition()));case 6:return e.abrupt("return",Promise.resolve(t.getSpeechSynthesis()));case 7:return e.abrupt("return",Promise.resolve(!1));case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),this.state={getUserMedia:void 0,AudioContext:void 0,SpeechRecognition:void 0,SpeechSynthesis:void 0}};t.default=function(e,t,n,r){var i=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"mp3",u=function e(){c()(this,e)},d=null,l=[],p=void 0,f=!0,h=!0,v=!0,g=!1,m="#intro",w=void 0,x="en",S=["error"],k=void 0,I=i?this:new u;I.botCallback=r,I.sessionEnded=!1;var A=!1,E=0,P=!1,O=!1,C=!1,L=0,N=[],M="",R={listening:new Audio("https://repository.flowstorm.ai/audio/client/listening.mp3"),recognized:new Audio("https://repository.flowstorm.ai/audio/client/recognized.mp3"),waiting:new Audio("https://repository.flowstorm.ai/audio/client/waiting.mp3"),error:new Audio("https://repository.flowstorm.ai/audio/client/error.mp3"),sleep:new Audio("https://repository.flowstorm.ai/audio/client/sleep.mp3")},T=t;function _(){E=0;var t=(p=new Audio("https://repository.flowstorm.ai/audio/client/intro.mp3")).play();void 0!==t&&t.then((function(e){S.includes("intro")||(p.pause(),p.currentTime=0),console.log("Audio OK")})).catch((function(e){console.error(e)}));var n=function(e){R[e].volume=0,R[e].play().then((function(t){R[e].pause(),R[e].currentTime=0}))};for(var r in R)n(r);L=Y(),console.log("Bot init"),G("INFO","Bot init");return(d=new y(new b,e.replace("http","ws")+"/socket/",z,U,w,x,T,I,k,a)).open().then((function(){})).catch((function(e){U({type:"Client",message:"Error opening socket:  ".concat(e)})})),this}function G(e,t){var n=new Date,r=(Y()-L)/1e3;N.push({time:n,relativeTime:r,level:e,text:t})}function j(e){G("INFO","Client status changed to "+e),r.setStatus({status:e})}function U(e){Z("error"),G("ERROR",e.message),d.sendLogs(N),N=[],r.onError(e),I.onStopClick(),r.onEnd()}function D(e){return null!==e&&e}function F(){p.removeEventListener("ended",F),I.addRecord()}void 0===t&&void 0!==window.localStorage&&(null===localStorage.getItem("sender")?(T=s()(Array(16)).map((function(){return Math.floor(16*Math.random()).toString(16)})).join(""),localStorage.setItem("sender",T)):T=localStorage.getItem("sender")),I.pause=function(){j("PAUSED"),""!==p.src&&f&&p.pause()},I.resume=function(){j("RESPONDING"),""!==p.src&&f?p.play():f||(J(),j("LISTENING"))},I.inAudio=function(e){G("INFO","Input audio "+((h=!h)?"on":"off")),"LISTENING"===e&&(h?W(C):I.closeAudioStream("InputAudioEvent",!0))},I.getInAudio=function(){return h},I.outAudio=function(e){f?("RESPONDING"===e&&q(),f=!1):f=!0,G("INFO","Output audio "+(f?"on":"off"))},I.getOutAudio=function(){return f},I.click=function(e){switch(G("INFO","Click on state "+e),e){case"RESPONDING":q()}},I.playAudio=function(e){G("INFO","Playing audio file "+e),e&&f&&(p.src=e,p.addEventListener("ended",F),p.play().catch((function(e){U({type:"Client",message:"Audio error in ".concat(p.src,":  ").concat(e)})}))),""!==p.src&&f&&e||I.addRecord()},I.startTyping=function(){C=!0},window.addEventListener("message",(function(e){"BotStopEvent"===e.data&&I.onStopClick()})),I.init=function(e,t,n,r){var o=this,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"#intro",s=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:["error"],c=arguments.length>7&&void 0!==arguments[7]&&arguments[7],u=arguments.length>8&&void 0!==arguments[8]?arguments[8]:void 0;if(f=r,h=n,w=e,x=t,m=i,v=s,S=a,g=c,k=u,E<Y()||0===E)return _();E=0,d.sendText(m).then((function(e){return L=Y(),$(m),o})).catch((function(e){_()}))},I.addRecord=function(){if(D(l)&&l.length>0){var e=l,t=o()(e),n=t[0],i=t.slice(1),s=n.audio,a=n.image,c=n.text,u=n.background,h=n.video,v=n.code,g=n.nodeId;r.focusOnNode&&0!==g&&r.focusOnNode(g),h?r.addVideo(h,(function(){l=i,""!==p.src&&f&&s||I.addRecord()})):(l=i,c.startsWith("#")?(r.handleCommand(c,v),"#walk"!==c&&I.addRecord()):(r.addMessage("received",c,a,u),I.playAudio(s)))}else if(P)O=!0;else{if(d.sessionId&&0===E)setTimeout((function(){W(!C)}),A?200:0);else(I.sessionEnded||0!==E)&&(Z("sleep"),r.onEnd()),r.setStatus({isActive:!0,status:"SLEEPING"});l=void 0}};var B=function(t){var n=t.audio,r=t.image,o=t.text,i=t.ssml,s=t.background,a=t.video,c=t.code,u=t.nodeId;return{audio:D(n)?n.startsWith("/")?"".concat(e).concat(n):n:D(i)&&i.includes("<audio")?i.split('"')[1]:null,image:D(r)?r.startsWith("/")?"".concat(e).concat(r):r:null,video:D(a)?a:null,text:D(o)?o:"",background:D(s)?0===s.length?null:s:null,code:D(c)?0===c.length?"{}":c:"{}",nodeId:D(u)?u:0}};function z(e){var t=e.response,o=void 0===t?[]:t.items;switch(G("INFO","Received event "+e.type),e.type){case"ResponseItem":j("RESPONDING"),K();var i=B(e.responseItem);void 0===l&&(l=[]),l.push(i),P&&!O||(O=!1,P=!0,I.addRecord());break;case"Response":j("RESPONDING"),K(),d.language=t.locale,0===o.length,t.sleepTimeout>0&&(E=Y()+1e3*t.sleepTimeout);var s=o.map(B);l=void 0!==l?l.concat(s):s,r.addLogs(t.logs),t.sessionEnded&&(I.sessionEnded=!0,d.setSessionId(null)),!P||O?(P=!1,O=!1,I.addRecord()):P=!1;break;case"Recognized":var a=(void 0===e.message?[e]:e.message.items)[0];(a.text.length>M.length||a.isFinal)&&(M=a.text,$(a.text)),L=Y(),a.isFinal&&(M="",j("PROCESSING"),I.closeAudioStream("recognized",!1));break;case"Ready":d.setSessionId(r.getUUID()),I.sessionEnded=!1,A=!1,n?($(m),d.sendText(m),L=Y()):r.play("bot_ready");break;case"InputAudioStreamOpen":j("LISTENING");break;case"SessionStarted":var c=e.sessionId;M="",d.setSessionId(c),j("RESPONDING");break;case"Error":if(r.onError({type:"Server:",message:e.text}),Z("error"),null===c)break;case"SessionEnded":d.sendLogs(N),N=[],L=0,I.sessionEnded=!0,I.closeAudioStream("sessionEnd",!1),d.setSessionId(null),f||(r.onEnd(),K(),Z("sleep"),j("SLEEPING"))}}function W(e){d.sendLogs(N),N=[],h&&e&&!A&&E<Y()?(Z("listening"),d.getStt().start().then((function(){A=!0})).catch((function(e){g?(I.setInputAudio(!1),j("LISTENING")):U({type:"Client",message:"Speech to text start error: ".concat(e)})}))):j("LISTENING")}function J(){""!==p.src&&(p.pause(),p.src="",D(l)&&l.length>0&&(l.forEach((function(e){r.addMessage("received",e.text,e.image,e.background)})),l=void 0))}function K(){R.waiting.removeEventListener("ended",V),R.waiting.pause(),R.waiting.currentTime=0}function V(){Z("waiting")}function Z(e){S.includes(e)&&(R[e].volume=1,R[e].currentTime=0,R[e].play())}function Y(){return(new Date).getTime()}function q(){J(),E>0?(r.onEnd(),j("SLEEPING")):I.sessionEnded?(I.onStopClick(),r.onEnd()):(W(!0),j("LISTENING"))}function $(e){var t="#"===e.charAt(0)&&v?null:e,n=e;r.addMessage("sent",t,null,null,n)}return I.closeAudioStream=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"default",t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];"sessionEnd"!==e&&Z("recognized"),A&&d.getStt().stop(t).then((function(){A=!1})).catch((function(){U({type:"Client",message:"Speech to text stop error in ".concat(e)})}))},I.handleOnTextInput=function(e,t){J(),C=!1,E=0,$(e),j("PROCESSING"),d.sendText(e),L=Y(),t&&h&&I.closeAudioStream("handleTextInput",!1)},I.onStopClick=function(){I.sessionEnded=!0,K(),p&&J(),d&&(d.setSessionId(null),d.close()),E=0,j("SLEEPING")},I}}])}));